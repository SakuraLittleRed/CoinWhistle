"""
ç®¡ç†å‘˜å‘½ä»¤æ¨¡å— - ç¤ºä¾‹æ–‡ä»¶

âš ï¸ æ­¤æ–‡ä»¶ä»…ä½œä¸ºæ¨¡æ¿ï¼Œä¸ä¼šç”Ÿæ•ˆï¼
è¦å¯ç”¨ç®¡ç†å‘˜åŠŸèƒ½ï¼Œè¯·æ‰§è¡Œï¼š

1. å¤åˆ¶æ­¤æ–‡ä»¶ä¸º admin_commands.py:
   cp admin_commands.py.example admin_commands.py

2. admin_commands.py ä¼šè‡ªåŠ¨è¢«ç³»ç»ŸåŠ è½½

3. è®¾ç½®ç¯å¢ƒå˜é‡ ADMIN_USER_IDSï¼ˆåœ¨ .env æ–‡ä»¶ä¸­ï¼‰:
   ADMIN_USER_IDS=ä½ çš„telegram_user_id

4. é‡å¯åº”ç”¨åï¼Œç®¡ç†å‘˜å‘½ä»¤ï¼ˆ/admin, /users, /broadcastï¼‰å³å¯ä½¿ç”¨

æ³¨æ„ï¼š
- admin_commands.py æ–‡ä»¶ä¸ä¼šè¢«æäº¤åˆ° Gitï¼ˆå·²åœ¨ .gitignore ä¸­ï¼‰
- å¦‚æœéœ€è¦ç®¡ç†å‘˜åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ­¤æ–‡ä»¶
"""
from typing import TYPE_CHECKING
from telegram import Update
from telegram.ext import ContextTypes
from telegram.constants import ParseMode

from config import user_manager

if TYPE_CHECKING:
    from telegram_bot import TelegramBot


class AdminCommands:
    """ç®¡ç†å‘˜å‘½ä»¤ - åŠ¨æ€æ³¨å…¥åˆ° TelegramBot"""
    
    def __init__(self, bot: 'TelegramBot'):
        self.bot = bot
    
    async def cmd_admin(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ç®¡ç†å‘˜é¢æ¿: /admin"""
        user_config = self.bot._get_user(update)
        if not user_manager.is_admin(user_config.user_id):
            await update.message.reply_text("âŒ æ— æƒé™")
            return
        
        users = user_manager.get_all_users()
        active = len([u for u in users if u.is_active])
        
        engine_stats = {}
        if self.bot.system and hasattr(self.bot.system, 'alert_engine'):
            engine_stats = self.bot.system.alert_engine.get_stats()
        
        await update.message.reply_text(
            f"ğŸ‘‘ <b>ç®¡ç†å‘˜é¢æ¿</b>\n\n"
            f"<b>ç”¨æˆ·:</b> {len(users)} (æ´»è·ƒ: {active})\n\n"
            f"<b>æŠ¥è­¦ç»Ÿè®¡:</b>\n"
            f"â€¢ æ€»æŠ¥è­¦: {engine_stats.get('total_alerts', 0)}\n"
            f"â€¢ âš¡ å‡çº§ç©¿é€: {engine_stats.get('escalation_count', 0)}\n"
            f"â€¢ æ´»è·ƒå†·å´: {engine_stats.get('active_cooldowns', 0)}\n\n"
            f"/users - ç”¨æˆ·åˆ—è¡¨\n"
            f"/broadcast æ¶ˆæ¯ - å¹¿æ’­",
            parse_mode=ParseMode.HTML
        )
    
    async def cmd_users(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ç”¨æˆ·åˆ—è¡¨: /users"""
        user_config = self.bot._get_user(update)
        if not user_manager.is_admin(user_config.user_id):
            await update.message.reply_text("âŒ æ— æƒé™")
            return
        
        users = user_manager.get_all_users()
        text = "ğŸ‘¥ <b>ç”¨æˆ·åˆ—è¡¨</b>\n\n"
        
        for u in users[:20]:
            status = "âœ…" if u.is_active else "âŒ"
            admin = "ğŸ‘‘" if u.is_admin else ""
            tz = f"UTC{u.timezone_offset:+d}"
            night = "ğŸŒ™" if u.alert_mode.night.enabled else ""
            text += f"{status}{admin}{night} {u.username or u.user_id[:8]} ({tz})\n"
        
        if len(users) > 20:
            text += f"\n... å…± {len(users)} ä¸ª"
        
        await update.message.reply_text(text, parse_mode=ParseMode.HTML)
    
    async def cmd_broadcast(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """å¹¿æ’­æ¶ˆæ¯: /broadcast <æ¶ˆæ¯>"""
        user_config = self.bot._get_user(update)
        if not user_manager.is_admin(user_config.user_id):
            await update.message.reply_text("âŒ æ— æƒé™")
            return
        
        message = ' '.join(context.args or [])
        if not message:
            await update.message.reply_text("ç”¨æ³•: /broadcast <æ¶ˆæ¯>")
            return
        
        await self.bot.notifier.broadcast(f"ğŸ“¢ <b>ç³»ç»Ÿå…¬å‘Š</b>\n\n{message}")
        await update.message.reply_text("âœ… å¹¿æ’­å·²å‘é€")
